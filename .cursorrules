# Service Desk — Project Rules for Cursor AI

## Stack
- Backend: ASP.NET Core 8, ASP.NET Core Identity, EF Core 8, PostgreSQL, JWT
- Frontend: React 18, TypeScript, Vite, Ant Design 5, TanStack Query v5, React Router v6
- Tests: xUnit (backend)
- Infra: Docker, GitHub Actions CI

## Project structure
/server                 — ASP.NET Core Web API + tests
  /ServiceDesk.API
  /ServiceDesk.API.Tests
/client                 — Vite React app
/http                   — .http files for API checks (final lab)
/docs                   — course materials (labs, ADR, figma link)

## Backend conventions
- All API errors → ProblemDetails (RFC 7807)
- HTTP codes: 400 (validation/business), 401, 403, 404, 409 (conflict/anti-steal)
- Controllers are thin — business logic in services
- EF Core: no lazy loading, explicit .Include()
- Migrations in repo, never auto-migrate on startup
- ILogger<T> for structured logging in services
- GET /health → 200 (health check)

## Roles & Auth
- Roles: Student, Operator, Admin (exactly one per user)
- JWT access token, stored in localStorage (MVP, no refresh)
- Role change takes effect after next login (new JWT)
- displayName = ApplicationUser.DisplayName (custom field, added in Lab 3)

## Lab 03 (Auth) requirements
- Global Exception Middleware: catch unhandled exceptions and return ProblemDetails consistently (RFC 7807).
- Swagger/OpenAPI (Development): enable Swagger UI, configure Bearer auth, and document auth endpoints response codes (200/400/401/403) + ProblemDetails on errors.
- Register behavior: on successful POST /api/auth/register assign default role Student and return { accessToken } (JWT).
- displayName: use ApplicationUser.DisplayName — decision fixed in "Roles & Auth" section above.
  Record in ADR.md (Lab 08).

## Security rules
- Student: assignedToMe query param is ignored by server (server enforces own tickets only)
- Student: sees ONLY own tickets; foreign ticket → 404 (not 403)
- Admin: can GET all tickets (same as Operator), with filters
- POST /api/tickets → Student only; Operator/Admin → 403
- POST /api/tickets/{id}/close → Student only; Operator/Admin → 403
- Admin: cannot create/comment tickets in MVP

## Ticket workflow (strict)
Statuses: New, InProgress, WaitingForStudent, Resolved, Closed, Rejected
Priorities: Low, Medium, High

New → InProgress: ONLY via assign-to-me
InProgress → WaitingForStudent: Operator (assignee only)
WaitingForStudent → InProgress: Operator (assignee only) OR auto on Student comment
InProgress → Resolved: Operator (assignee only)
WaitingForStudent → Resolved: Operator (assignee only)
Resolved → Closed: Student (author only) via /close
Any active → Rejected: Operator via /reject (with reason)

assign-to-me checks (in order):
1. status ∈ {New, InProgress, WaitingForStudent} else 400
2. anti-steal: assigneeId != null && != currentOperator → 409
3. set assigneeId = currentOperatorId
4. if was New → set InProgress

POST /api/tickets/{id}/status checks (Operator only):
1. if assigneeId != currentOperatorId → 403
2. if requested status == current status → 400
3. if transition is not allowed by workflow → 400
Note: New → InProgress is ONLY via assign-to-me (status endpoint must reject it as invalid).

reject checks (in order):
1. status ∈ {New, InProgress, WaitingForStudent} else 400
2. assigneeId != null && != currentOperator → 409
3. if New && assigneeId==null → auto-assign currentOperator
4. set Rejected + rejectedReason (reason is required)

POST /api/tickets/{id}/close checks (Student only):
1. if role is Operator/Admin → 403
2. if foreign ticket → 404
3. if status != Resolved → 400
4. set Closed

## DTO contracts (always return nested objects, never bare ids)
TicketResponse:
  id, title, description, priority, status, createdAt, updatedAt, rejectedReason?
  category: { id, name, isActive }
  author: { id, displayName }
  assignee?: { id, displayName }

CommentResponse:
  id, ticketId, text, isInternal, createdAt
  author: { id, displayName }

## Anti-necropost (comments)
- WaitingForStudent + Student comment → auto-set status to InProgress (server side)
- Auto-transition applies ONLY for Student comment; Operator comment does NOT auto-change status
- Closed/Rejected → 400 for everyone
- Resolved → Student cannot comment (400); only action is /close
- Operator comment checks: 1) Closed/Rejected→400, 2) not assignee→403, 3) create

## isInternal comments
- Student: cannot create internal (server forces isInternal=false), cannot see isInternal=true
- Operator: can create internal ONLY if assigneeId == currentOperatorId
- Admin: cannot comment → 403

## Seed data (Lab 05)
- Provide DbInitializer / SeedData on app start (dev only)
- Seed users (check by email, idempotent):
    admin@demo.com / Admin123! → Admin
    operator1@demo.com / Operator123! → Operator
    operator2@demo.com / Operator123! → Operator
    student1@demo.com / Student123! → Student
    student2@demo.com / Student123! → Student
    student3@demo.com / Student123! → Student
- Create: 5 Categories (mix active/inactive)
- Create: 15+ Tickets covering all statuses & priorities, some assigned,
  include WaitingForStudent and Rejected with reason

## Frontend conventions
- TanStack Query for ALL server state (useQuery / useMutation)
- AuthContext: { user, role, isAuthenticated, login, register, logout, init }
- RequireAuth: no token → /login
- RequireRole: wrong role → 403 page
- UI states: PageLoading (Spin), PageEmpty, PageError (Alert/Result),
  PageValidation (Form errors), PageNotFound (Result 404)
- Conditional buttons: show/hide based on role + status + assignee rules
  (never just disable without reason)
- Internal toggle: show ONLY if Operator && assigneeId == currentOperatorId
- /queue/resolved: read-only monitoring for Operator; no actions
  (no assign/status/reject buttons)
